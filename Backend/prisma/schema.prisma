// Prisma Schema for Open World Chat
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Guest User - Anonymous users with generated UUID
model GuestUser {
  id              String        @id @default(uuid())
  guestId         String        @unique
  username        String
  avatarId        Int           @default(1) // References pre-stored avatar (1-10)
  customAvatarUrl String?       // Custom uploaded avatar URL from S3
  userTitle       String        @default("common") // "common", "VIP", "Activist", "Warrior", "Pro Gamer" etc.
  lastActiveAt    DateTime      @default(now())
  createdAt       DateTime      @default(now())
  messages        Message[]
  settings        UserSettings?

  @@index([lastActiveAt])
}

// Message - Chat messages with reactions and replies
model Message {
  id               String    @id @default(uuid())
  content          String?
  imageUrl         String?
  fileUrl          String?   // S3 file URL
  fileType         String?   // MIME type (image/jpeg, video/mp4, etc.)
  fileName         String?   // Original filename
  fileSize         Int?      // Size in bytes
  senderId         String
  senderName       String
  replyToMessageId String?
  replyToMessage   Message?  @relation("MessageReplies", fields: [replyToMessageId], references: [id], onDelete: SetNull)
  replies          Message[] @relation("MessageReplies")
  reactions        Json      @default("{}")
  isEdited         Boolean   @default(false)
  isDeleted        Boolean   @default(false)
  editedAt         DateTime?
  createdAt        DateTime  @default(now())
  sender           GuestUser @relation(fields: [senderId], references: [guestId], onDelete: Cascade)

  @@index([createdAt])
  @@index([senderId])
  @@index([content])
}

// User Settings - Theme and notification preferences
model UserSettings {
  id            String    @id @default(uuid())
  guestId       String    @unique
  theme         String    @default("dark") // "dark" | "light"
  notifications Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  guest         GuestUser @relation(fields: [guestId], references: [guestId], onDelete: Cascade)
}

// Room Metadata - Global chat room information
model RoomMetadata {
  id          String @id @default(uuid())
  name        String @default("Global Chat Room")
  description String @default("Join the conversation instantly. No login, no history tracking. Just pick a name and say hello to the world.")
}

// Avatar - Pre-stored avatar images
model Avatar {
  id        Int      @id @default(autoincrement())
  name      String
  url       String
  createdAt DateTime @default(now())
}
